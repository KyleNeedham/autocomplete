(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};!function(a,b){return"function"==typeof define&&define.amd?define(["jquery","bootstrap","underscore","backbone","marionette"],b):a.AutoComplete=b(a,{},a.Backbone.$,a._,a.Backbone,a.Backbone.Marionette)}(this,function(a,c,d,e,f,g){return c.Collection=function(a){function c(a,b){this.options=b,this.setDataset(a),c.__super__.constructor.call(this,[],b)}return b(c,a),c.prototype.initialize=function(){return this._initializeListeners()},c.prototype._initializeListeners=function(){return this.listenTo(this,"find",this.fetchNewSuggestions),this.listenTo(this,"select:active",this.selectActive),this.listenTo(this,"highlight:next",this.selectNext),this.listenTo(this,"highlight:previous",this.selectPrevious),this.listenTo(this,"clear",this.reset)},c.prototype.setDataset=function(a){return this.dataset=this.parse(a,!1)},c.prototype.parse=function(a,b){return b&&(a=e.take(a,this.options.paramValues.limit)),e.map(a,function(a){return{value:this.getValue(a)}},this)},c.prototype.getValue=function(a){return e.reduce(this.options.valueKey.split("."),function(a,b){return a[b]},a)},c.prototype.buildParams=function(a){var b;return b={},b[this.options.paramKeys.search]=a,e.each(this.options.paramKeys,function(a){return null!=b[a]?b[a]:b[a]=this.options.paramValues[a]},this),{data:b}},c.prototype.fetchNewSuggestions=function(a){switch(this.options.type){case"remote":return this.fetch(e.extend({url:this.options.remote},this.buildParams(a)));case"dataset":return this.filterDataSet(a);default:throw new Error("Unkown type passed")}},c.prototype.filterDataSet=function(a){var b;return b=[],e.each(this.dataset,function(c){return b.length>=this.options.paramValues.limit?!1:this.matches(c.value,a)?b.push(c):void 0},this),this.reset(b)},c.prototype.matches=function(a,b){return a=this.normalizeValue(a),b=this.normalizeValue(b),a.indexOf(b)>=0},c.prototype.normalizeValue=function(a){return null==a&&(a=""),a.toLowerCase().replace(/^\s*/g,"").replace(/\s{2,}/g," ")},c.prototype.selectActive=function(){return this.trigger("selected",this.at(this.isStarted()?this.index:0))},c.prototype.selectPrevious=function(){return!this.isFirst()&&this.isStarted()?(this.deselect(this.index),this.select(this.index=this.index-1)):void 0},c.prototype.selectNext=function(){return this.isLast()?void 0:(this.isStarted()&&this.deselect(this.index),this.select(this.index=this.index+1))},c.prototype.isFirst=function(){return 0===this.index},c.prototype.isLast=function(){return this.index+1===this.length},c.prototype.isStarted=function(){return-1!==this.index},c.prototype.select=function(a){var b;return b=this.at(a),b.trigger("highlight",b)},c.prototype.deselect=function(a){var b;return b=this.at(a),b.trigger("highlight:remove",b)},c.prototype.reset=function(){return this.index=-1,c.__super__.reset.apply(this,arguments)},c}(f.Collection),c.ChildView=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.tagName="li",c.prototype.className="ac-suggestion",c.prototype.template=e.template('<a href="#" data-action="select"><%= value %></a>'),c.prototype.events={"click a":"select"},c.prototype.modelEvents={highlight:"highlight","highlight:remove":"removeHighlight"},c.prototype.highlight=function(){return this.$el.addClass("active")},c.prototype.removeHighlight=function(){return this.$el.removeClass("active")},c.prototype.select=function(a){return a.preventDefault(),this.model.trigger("selected",this.model)},c}(g.ItemView),c.CollectionView=function(a){function d(){return d.__super__.constructor.apply(this,arguments)}return b(d,a),d.prototype.tagName="ul",d.prototype.className="ac-suggestions dropdown-menu",d.prototype.childView=c.ChildView,d.prototype.initialize=function(){},d}(g.CollectionView),c.Behavior=function(a){function d(){return d.__super__.constructor.apply(this,arguments)}return b(d,a),d.prototype.defaults={containerTemplate:'<div class="ac-container dropdown"></div>',type:"remote",data:[],remote:null,valueKey:"value",paramKeys:{search:"search",limit:"limit"},paramValues:{search:null,limit:10},rateLimit:500,minLength:1},d.prototype.eventPrefix="autocomplete",d.prototype.actionKeysMap={27:"esc",37:"left",39:"right",13:"enter",38:"up",40:"down"},d.prototype.ui={input:'[data-action="autocomplete"]'},d.prototype.events={"keyup @ui.input":"onKeydown","blur @ui.input":"onBlur"},d.prototype.initialize=function(){return this.options.paramKeys=e.extend(this.defaults.paramKeys,this.options.paramKeys),this.options.paramValues=e.extend(this.defaults.paramValues,this.options.paramValues),this.updateSuggestions=e.throttle(this._updateSuggestions,this.options.rateLimit),this._initializeSuggestionsCollection(),this._initializeListeners()},d.prototype._initializeSuggestionsCollection=function(){return this.suggestionsCollection=new c.Collection(this.options.data,e.omit(this.options,["containerTemplate","rateLimit","minLength"]))},d.prototype._initializeListeners=function(){return this.listenTo(this.suggestionsCollection,"all",this.relayCollectionEvent),this.listenTo(this,""+this.eventPrefix+":open",this.open),this.listenTo(this,""+this.eventPrefix+":close",this.close),this.listenTo(this,""+this.eventPrefix+":suggestions:selected",this.completeSuggestion)},d.prototype.onRender=function(){return this._initializeAutoComplete(),this.setInputElementAttributes()},d.prototype._initializeAutoComplete=function(){return this.ui.input.wrap(this.options.containerTemplate),this.ui.container=this.ui.input.parent(),this.collectionView=this._getCollectionView(),this.ui.container.append(this.collectionView.render().el)},d.prototype._getCollectionView=function(){return new c.CollectionView({collection:this.suggestionsCollection})},d.prototype.setInputElementAttributes=function(){return this.ui.input.addClass("ac-input").attr({autocomplete:"off",spellcheck:!1,dir:"auto"})},d.prototype.relayCollectionEvent=function(a,b){return this.triggerShared(""+this.eventPrefix+":suggestions:"+a,b)},d.prototype.triggerShared=function(){var a;return this.trigger.apply(this,arguments),(a=this.view).trigger.apply(a,arguments)},d.prototype.onKeydown=function(a){var b;return b=a.which||a.keyCode,this.ui.input.val().length<this.options.minLength?void 0:null!=this.actionKeysMap[b]?this.doAction(b,a):this.updateSuggestions(this.ui.input.val())},d.prototype.onBlur=function(){return setTimeout(function(a){return function(){return a.isOpen?a.triggerShared(""+a.eventPrefix+":close",a.ui.input.val()):void 0}}(this),250)},d.prototype.doAction=function(a,b){var c;if(c=this.actionKeysMap[a],!this.suggestionsCollection.isEmpty())switch(c){case"right":if(b.target.value.length===b.target.selectionEnd)return this.suggestionsCollection.trigger("select:active");break;case"enter":return this.suggestionsCollection.trigger("select:active");case"down":return this.suggestionsCollection.trigger("highlight:next");case"up":return this.suggestionsCollection.trigger("highlight:previous");case"esc":return this.trigger(""+this.eventPrefix+":close")}},d.prototype._updateSuggestions=function(a){return this.isOpen||this.triggerShared(""+this.eventPrefix+":open"),this.suggestionsCollection.trigger("find",a)},d.prototype.open=function(){return this.isOpen=!0,this.ui.container.addClass("open")},d.prototype.completeSuggestion=function(a){return this.ui.input.val(a.get("value")),this.triggerShared(""+this.eventPrefix+":close",this.ui.input.val())},d.prototype.close=function(){return this.isOpen=!1,this.ui.container.removeClass("open"),this.suggestionsCollection.trigger("clear")},d.prototype.onDestroy=function(){return this.collectionView.destroy()},d}(g.Behavior)})}).call(this);