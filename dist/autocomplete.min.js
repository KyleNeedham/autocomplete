(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};!function(a,b){return"function"==typeof define&&define.amd?define(["underscore","jquery","backbone","marionette"],function(c,d,e,f){return b(a,{},c,d,e,f)}):a.AutoComplete=b(a,{},a._,a.jQuery,a.Backbone,a.Backbone.Marionette)}(this,function(a,c,d,e,f,g){return c.Collection=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.initialize=function(a,b){return this.options=b,this.setDataset(b.data),this._initializeListeners()},c.prototype._initializeListeners=function(){return this.listenTo(this,"find",this.fetchNewSuggestions),this.listenTo(this,"select",this.select),this.listenTo(this,"highlight:next",this.highlightNext),this.listenTo(this,"highlight:previous",this.highlightPrevious),this.listenTo(this,"clear",this.reset)},c.prototype.setDataset=function(a){return this.dataset=this.parse(a,!1)},c.prototype.parse=function(a,b){return b&&(a=d.take(a,this.options.values.limit)),d.map(a,function(a){return{value:this.getValue(a)}},this)},c.prototype.getValue=function(a){return d.reduce(this.options.valueKey.split("."),function(a,b){return a[b]},a)},c.prototype.buildParams=function(a){var b;return b={},b[this.options.keys.query]=a,d.each(this.options.keys,function(a){return null!=b[a]?b[a]:b[a]=this.options.values[a]},this),{data:b}},c.prototype.fetchNewSuggestions=function(a){switch(this.options.type){case"remote":return this.fetch(d.extend({url:this.options.remote},this.buildParams(a)));case"dataset":return this.filterDataSet(a);default:throw new Error("Unkown type passed")}},c.prototype.filterDataSet=function(a){var b;return b=[],d.each(this.dataset,function(c){return b.length>=this.options.values.limit?!1:this.matches(c.value,a)?b.push(c):void 0},this),this.reset(b)},c.prototype.matches=function(a,b){return a=this.normalizeValue(a),b=this.normalizeValue(b),a.indexOf(b)>=0},c.prototype.normalizeValue=function(a){return null==a&&(a=""),a.toLowerCase().replace(/^\s*/g,"").replace(/\s{2,}/g," ")},c.prototype.select=function(){return this.trigger("selected",this.at(this.isStarted()?this.index:0))},c.prototype.highlightPrevious=function(){return!this.isFirst()&&this.isStarted()?(this.deHighlight(this.index),this.highlight(this.index=this.index-1)):void 0},c.prototype.highlightNext=function(){return this.isLast()?void 0:(this.isStarted()&&this.deHighlight(this.index),this.highlight(this.index=this.index+1))},c.prototype.isFirst=function(){return 0===this.index},c.prototype.isLast=function(){return this.index+1===this.length},c.prototype.isStarted=function(){return-1!==this.index},c.prototype.highlight=function(a){var b;return b=this.at(a),b.trigger("highlight",b)},c.prototype.deHighlight=function(a){var b;return b=this.at(a),b.trigger("highlight:remove",b)},c.prototype.reset=function(){return this.index=-1,c.__super__.reset.apply(this,arguments)},c}(f.Collection),c.ChildView=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.tagName="li",c.prototype.className="ac-suggestion",c.prototype.template=d.template('<a href="#"><%= value %></a>'),c.prototype.events={"click a":"select"},c.prototype.modelEvents={highlight:"highlight","highlight:remove":"removeHighlight"},c.prototype.highlight=function(){return this.$el.addClass("active")},c.prototype.removeHighlight=function(){return this.$el.removeClass("active")},c.prototype.select=function(a){return a.preventDefault(),this.model.trigger("selected",this.model)},c}(g.ItemView),c.CollectionView=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.tagName="ul",c.prototype.className="ac-suggestions dropdown-menu",c.prototype.emptyView=g.ItemView.extend({tagName:"li",template:d.template('<a href="#">No suggestions available</a>')}),c}(g.CollectionView),c.Behavior=function(a){function f(){return f.__super__.constructor.apply(this,arguments)}return b(f,a),f.prototype.defaults={containerTemplate:'<div class="ac-container dropdown"></div>',rateLimit:100,minLength:1,collection:{definition:c.Collection,options:{type:"remote",remote:null,data:[],valueKey:"value",keys:{query:"query",limit:"limit"},values:{query:null,limit:10}}},collectionView:{definition:c.CollectionView},childView:{definition:c.ChildView}},f.prototype.eventPrefix="autocomplete",f.prototype.actionKeysMap={27:"esc",37:"left",39:"right",13:"enter",38:"up",40:"down"},f.prototype.events={"keyup @ui.autocomplete":"onKeydown","blur @ui.autocomplete":"onBlur"},f.prototype.initialize=function(a){return this.options=e.extend(!0,{},this.defaults,a),this.suggestions=new this.options.collection.definition([],this.options.collection.options),this.updateSuggestions=d.throttle(this._updateSuggestions,this.options.rateLimit),this._initializeListeners()},f.prototype._initializeListeners=function(){return this.listenTo(this.suggestions,"all",this.relayCollectionEvent),this.listenTo(this,""+this.eventPrefix+":open",this.open),this.listenTo(this,""+this.eventPrefix+":close",this.close),this.listenTo(this,""+this.eventPrefix+":suggestions:highlight",this.fillSuggestion),this.listenTo(this,""+this.eventPrefix+":suggestions:selected",this.completeSuggestion)},f.prototype.onRender=function(){return this._initializeAutoComplete(),this.setInputElementAttributes()},f.prototype._initializeAutoComplete=function(){return this.$autocomplete=this.view.ui.autocomplete,this.$autocomplete.wrap(this.options.containerTemplate),this.$container=this.$autocomplete.parent(),this.collectionView=this.getCollectionView(),this.$container.append(this.collectionView.render().el)},f.prototype.getCollectionView=function(){return new this.options.collectionView.definition({childView:this.options.childView.definition,collection:this.suggestions})},f.prototype.setInputElementAttributes=function(){return this.$autocomplete.addClass("ac-input").attr({autocomplete:"off",spellcheck:!1,dir:"auto"})},f.prototype.relayCollectionEvent=function(a,b){return this.triggerShared(""+this.eventPrefix+":suggestions:"+a,b)},f.prototype.triggerShared=function(){var a;return this.trigger.apply(this,arguments),(a=this.view).trigger.apply(a,arguments)},f.prototype.onKeydown=function(a){var b;return b=a.which||a.keyCode,this.$autocomplete.val().length<this.options.minLength?void 0:null!=this.actionKeysMap[b]?this.doAction(b,a):this.updateSuggestions(this.$autocomplete.val())},f.prototype.onBlur=function(){return setTimeout(function(a){return function(){return a.isOpen?a.triggerShared(""+a.eventPrefix+":close",a.$autocomplete.val()):void 0}}(this),250)},f.prototype.doAction=function(a,b){if(b.preventDefault(),b.stopPropagation(),!this.suggestions.isEmpty())switch(this.actionKeysMap[a]){case"right":if(this.isSelectionEnd(b))return this.suggestions.trigger("select");break;case"enter":return this.suggestions.trigger("select");case"down":return this.suggestions.trigger("highlight:next");case"up":return this.suggestions.trigger("highlight:previous");case"esc":return this.trigger(""+this.eventPrefix+":close")}},f.prototype._updateSuggestions=function(a){return this.isOpen||this.triggerShared(""+this.eventPrefix+":open"),this.suggestions.trigger("find",a)},f.prototype.isSelectionEnd=function(a){return a.target.value.length===a.target.selectionEnd},f.prototype.open=function(){return this.isOpen=!0,this.$container.addClass("open")},f.prototype.fillSuggestion=function(a){return this.$autocomplete.val(a.get("value"))},f.prototype.completeSuggestion=function(a){return this.fillSuggestion(a),this.triggerShared(""+this.eventPrefix+":close",this.$autocomplete.val())},f.prototype.close=function(){return this.isOpen=!1,this.$container.removeClass("open"),this.suggestions.trigger("clear")},f.prototype.onBeforeDestroy=function(){return this.collectionView.destroy()},f}(g.Behavior),c})}).call(this);